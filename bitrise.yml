---
format_version: '6'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: ios

workflows:
  deploy:
    steps:
    - script:
        deps:
          brew:
          - name: node
          - name: streamlayer/formulas/carthage
          - name: streamlayer/formulas/prefixify
        inputs:
        - content: |-
            #!/bin/bash

            set -ex

            yarn add semantic-release @semantic-release/exec @semantic-release/git
            trap 'git checkout -- RxBlocking RxCocoa RxRelay RxSwift RxTest Platform Tests' INT TERM HUP EXIT

            # 1. RxSwift
            TMPDIR=$(mktemp -d)
            DIR=RxSwift
            cp -R $DIR $TMPDIR
            swift-prefixify rewrite $TMPDIR/$DIR $PWD/$DIR \
              --report ./rxswift.json \
              --prefix $PREFIX \
              --exclude Event \
              --product-name RxSwift \
              --rewrite slr:rx

            # 2. RxRelay - depends on RxSwift
            TMPDIR=$(mktemp -d)
            DIR=RxRelay
            cp -R $DIR $TMPDIR
            swift-prefixify rewrite $TMPDIR/$DIR $PWD/$DIR \
              --include ./rxswift.json \
              --report ./rxrelay.json \
              --prefix $PREFIX \
              --product-name RxRelay \
              --rewrite slr:rx

            # 3. RxCocoa -- RxSwift & RxRelay
            TMPDIR=$(mktemp -d)
            DIR=RxCocoa
            cp -R $DIR $TMPDIR
            swift-prefixify rewrite $TMPDIR/$DIR $PWD/$DIR \
              --include ./rxswift.json \
              --include ./rxrelay.json \
              --report ./rxcocoa.json \
              --prefix $PREFIX \
              --product-name RxCocoa \
              --rewrite slr:rx

            # 4. RxTest
            TMPDIR=$(mktemp -d)
            DIR=RxTest
            cp -R $DIR $TMPDIR
            swift-prefixify rewrite $TMPDIR/$DIR $PWD/$DIR \
              --include ./rxswift.json \
              --report ./rxtest.json \
              --prefix $PREFIX \
              --exclude next \
              --exclude completed \
              --exclude error \
              --product-name RxTest \
              --rewrite slr:rx

            # 5. RxBlocking
            TMPDIR=$(mktemp -d)
            DIR=./RxBlocking
            cp -R $DIR $TMPDIR
            swift-prefixify rewrite $TMPDIR/$DIR $PWD/$DIR \
              --include ./rxswift.json \
              --report ./rxblocking.json \
              --prefix $PREFIX \
              --product-name RxBlocking \
              --rewrite slr:rx

            # 6. Platform-shared code
            TMPDIR=$(mktemp -d)
            DIR=./Platform
            cp -R $DIR $TMPDIR
            swift-prefixify rewrite $TMPDIR/$DIR $PWD/$DIR \
              --include ./rxswift.json \
              --include ./rxcocoa.json \
              --include ./rxrelay.json \
              --include ./rxblocking.json \
              --include ./rxtest.json \
              --prefix $PREFIX \
              --rewrite slr:rx

            yarn semantic-release

app:
  envs:
  - PREFIX: "SLR_"
